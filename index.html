



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.1.0">
    
    
      
        <title>LightInject</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.11e41852.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#installing" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="LightInject" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                LightInject
              </span>
              <span class="md-header-nav__topic">
                Home
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="LightInject" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    LightInject
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Home
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary" title="Binary" class="md-nav__link">
    Binary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source" title="Source" class="md-nav__link">
    Source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-container" title="Creating a container" class="md-nav__link">
    Creating a container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-services" title="Default services" class="md-nav__link">
    Default services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#named-services" title="Named services" class="md-nav__link">
    Named services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unresolved-services" title="Unresolved services" class="md-nav__link">
    Unresolved services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ienumerablet" title="IEnumerable&lt;T&gt;" class="md-nav__link">
    IEnumerable&lt;T&gt;
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ordering" title="Ordering" class="md-nav__link">
    Ordering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#values" title="Values" class="md-nav__link">
    Values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation" title="Compilation" class="md-nav__link">
    Compilation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-generics" title="Open Generics" class="md-nav__link">
    Open Generics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lifetime" title="Lifetime" class="md-nav__link">
    Lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#perscopelifetime" title="PerScopeLifetime" class="md-nav__link">
    PerScopeLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#percontainerlifetime" title="PerContainerLifetime" class="md-nav__link">
    PerContainerLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perrequestlifetime" title="PerRequestLifeTime" class="md-nav__link">
    PerRequestLifeTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-lifetime" title="Custom lifetime" class="md-nav__link">
    Custom lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important" title="Important" class="md-nav__link">
    Important
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-and-await" title="Async and Await" class="md-nav__link">
    Async and Await
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" title="Dependencies" class="md-nav__link">
    Dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor-injection" title="Constructor Injection" class="md-nav__link">
    Constructor Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration" title="Implicit service registration" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration" title="Explicit service registration" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters" title="Parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection" title="Property Injection" class="md-nav__link">
    Property Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration_1" title="Implicit service registration" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration_1" title="Explicit service registration" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection-on-existing-instances" title="Property injection on existing instances." class="md-nav__link">
    Property injection on existing instances.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-properyinjection" title="Disabling ProperyInjection" class="md-nav__link">
    Disabling ProperyInjection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializers" title="Initializers" class="md-nav__link">
    Initializers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembly-scanning" title="Assembly Scanning" class="md-nav__link">
    Assembly Scanning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-root" title="Composition Root" class="md-nav__link">
    Composition Root
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lazy-composition-roots" title="Lazy Composition Roots" class="md-nav__link">
    Lazy Composition Roots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compositionrootattribute" title="CompositionRootAttribute" class="md-nav__link">
    CompositionRootAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registerfrom" title="RegisterFrom" class="md-nav__link">
    RegisterFrom
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generics" title="Generics" class="md-nav__link">
    Generics
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constraints" title="Constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazyt" title="Lazy&lt;T&gt;" class="md-nav__link">
    Lazy&lt;T&gt;
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-factories" title="Function Factories" class="md-nav__link">
    Function Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#named-factories" title="Named Factories" class="md-nav__link">
    Named Factories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters_1" title="Parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable" title="IDisposable" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typed-factories" title="Typed Factories" class="md-nav__link">
    Typed Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_2" title="Parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable_1" title="IDisposable" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursive-dependency-detection" title="Recursive dependency detection" class="md-nav__link">
    Recursive dependency detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internals" title="Internals" class="md-nav__link">
    Internals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" title="Logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="designpatterns/" title="Patterns" class="md-nav__link">
      Patterns
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Extensions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Extensions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="interception/" title="Interception" class="md-nav__link">
      Interception
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="autofactory/" title="AutoFactory" class="md-nav__link">
      AutoFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="annotation/" title="Annotation" class="md-nav__link">
      Annotation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Integrations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Integrations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="xunit/" title="xUnit" class="md-nav__link">
      xUnit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="mvc/" title="Mvc" class="md-nav__link">
      Mvc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="wcf/" title="WCF" class="md-nav__link">
      WCF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="webapi/" title="Web Api" class="md-nav__link">
      Web Api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="signalr/" title="SignalR" class="md-nav__link">
      SignalR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="nancy/" title="Nancy" class="md-nav__link">
      Nancy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="microsoft.aspnetcore.hosting/" title="AspNetCore" class="md-nav__link">
      AspNetCore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="microsoft.dependencyinjection/" title="Microsoft DI" class="md-nav__link">
      Microsoft DI
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="webapirequestlogging/" title="Web Api Request Logging" class="md-nav__link">
      Web Api Request Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="transactions/" title="Transactions and Testing" class="md-nav__link">
      Transactions and Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="aspnetcoreunittesting/" title="AspNetCore unit testing" class="md-nav__link">
      AspNetCore unit testing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Side Projects
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Side Projects
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="lightmock/" title="LightMock" class="md-nav__link">
      LightMock
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="licence/" title="Licence" class="md-nav__link">
      Licence
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary" title="Binary" class="md-nav__link">
    Binary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source" title="Source" class="md-nav__link">
    Source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-container" title="Creating a container" class="md-nav__link">
    Creating a container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-services" title="Default services" class="md-nav__link">
    Default services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#named-services" title="Named services" class="md-nav__link">
    Named services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unresolved-services" title="Unresolved services" class="md-nav__link">
    Unresolved services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ienumerablet" title="IEnumerable&lt;T&gt;" class="md-nav__link">
    IEnumerable&lt;T&gt;
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ordering" title="Ordering" class="md-nav__link">
    Ordering
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#values" title="Values" class="md-nav__link">
    Values
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilation" title="Compilation" class="md-nav__link">
    Compilation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#open-generics" title="Open Generics" class="md-nav__link">
    Open Generics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lifetime" title="Lifetime" class="md-nav__link">
    Lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#perscopelifetime" title="PerScopeLifetime" class="md-nav__link">
    PerScopeLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#percontainerlifetime" title="PerContainerLifetime" class="md-nav__link">
    PerContainerLifetime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perrequestlifetime" title="PerRequestLifeTime" class="md-nav__link">
    PerRequestLifeTime
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-lifetime" title="Custom lifetime" class="md-nav__link">
    Custom lifetime
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#important" title="Important" class="md-nav__link">
    Important
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#async-and-await" title="Async and Await" class="md-nav__link">
    Async and Await
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" title="Dependencies" class="md-nav__link">
    Dependencies
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor-injection" title="Constructor Injection" class="md-nav__link">
    Constructor Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration" title="Implicit service registration" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration" title="Explicit service registration" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters" title="Parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection" title="Property Injection" class="md-nav__link">
    Property Injection
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implicit-service-registration_1" title="Implicit service registration" class="md-nav__link">
    Implicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explicit-service-registration_1" title="Explicit service registration" class="md-nav__link">
    Explicit service registration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-injection-on-existing-instances" title="Property injection on existing instances." class="md-nav__link">
    Property injection on existing instances.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-properyinjection" title="Disabling ProperyInjection" class="md-nav__link">
    Disabling ProperyInjection
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializers" title="Initializers" class="md-nav__link">
    Initializers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembly-scanning" title="Assembly Scanning" class="md-nav__link">
    Assembly Scanning
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#composition-root" title="Composition Root" class="md-nav__link">
    Composition Root
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lazy-composition-roots" title="Lazy Composition Roots" class="md-nav__link">
    Lazy Composition Roots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compositionrootattribute" title="CompositionRootAttribute" class="md-nav__link">
    CompositionRootAttribute
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registerfrom" title="RegisterFrom" class="md-nav__link">
    RegisterFrom
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generics" title="Generics" class="md-nav__link">
    Generics
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constraints" title="Constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazyt" title="Lazy&lt;T&gt;" class="md-nav__link">
    Lazy&lt;T&gt;
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-factories" title="Function Factories" class="md-nav__link">
    Function Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#named-factories" title="Named Factories" class="md-nav__link">
    Named Factories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parameters_1" title="Parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable" title="IDisposable" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typed-factories" title="Typed Factories" class="md-nav__link">
    Typed Factories
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_2" title="Parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idisposable_1" title="IDisposable" class="md-nav__link">
    IDisposable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recursive-dependency-detection" title="Recursive dependency detection" class="md-nav__link">
    Recursive dependency detection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internals" title="Internals" class="md-nav__link">
    Internals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" title="Logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/seesharper/lightinject/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Home</h1>
                
                <p><a href="https://ci.appveyor.com/project/seesharper/lightinject/branch/master"><img alt="AppVeyor" src="https://img.shields.io/appveyor/ci/seesharper/lightinject.svg?maxAge=2592000" /></a>
<a href="https://www.nuget.org/packages/LightInject"><img alt="NuGet" src="https://img.shields.io/nuget/v/LightInject.svg?maxAge=2592000" /></a>
<a href="https://github.com/seesharper/LightInject/releases/latest"><img alt="GitHub tag" src="https://img.shields.io/github/tag/seesharper/lightinject.svg?maxAge=2592000" /></a></p>
<h2 id="installing">Installing</h2>
<p><strong>LightInject</strong> provides two distribution models via NuGet</p>
<h3 id="binary">Binary</h3>
<div class="nuget-badge" >
   <p>
         <code>PM&gt; Install-Package LightInject</code>
   </p>
</div>

<p>This adds a reference to the LightInject.dll in the target project.</p>
<h3 id="source">Source</h3>
<div class="nuget-badge" >
   <p>
         <code>PM&gt; Install-Package LightInject.Source </code>
   </p>
</div>

<p>This will install a single file (LightInject.cs) into the current project.</p>
<h3 id="creating-a-container">Creating a container</h3>
<pre><code>var container = new LightInject.ServiceContainer();
</code></pre>
<p>The container implements IDisposable and should be disposed after usage has completed. It can also be used inside of a using statement for a constrained scope.</p>
<h3 id="default-services">Default services</h3>
<pre><code>public interface IFoo {}
public class Foo : IFoo {}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo, Foo&gt;();
var instance = container.GetInstance&lt;IFoo&gt;();
Assert.IsInstanceOfType(instance, typeof(Foo));
</code></pre>
<h3 id="named-services">Named services</h3>
<pre><code>public class Foo : IFoo {}
public class AnotherFoo : IFoo {}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Register&lt;IFoo, AnotherFoo&gt;("AnotherFoo");
var instance = container.GetInstance&lt;IFoo&gt;("AnotherFoo");
Assert.IsInstanceOfType(instance, typeof(AnotherFoo));
</code></pre>
<p>If only one named registration exists, <strong>LightInject</strong> is capable of resolving this as the default service.
​  <br />
    container.Register<IFoo, AnotherFoo>("AnotherFoo");
    var instance = container.GetInstance<IFoo>();
    Assert.IsInstanceOfType(instance, typeof(AnotherFoo));</p>
<h3 id="unresolved-services">Unresolved services</h3>
<p>LightInject can resolve services that are not registered with the container using the <em>RegisterFallback</em> method.</p>
<pre><code>var container = new ServiceContainer();
container.RegisterFallback((type, s) =&gt; true, request =&gt; new Foo());
var foo = container.GetInstance&lt;IFoo&gt;();
</code></pre>
<p>The first argument to the <em>RegisterFallback</em> method makes it possible to possible to decide if the service can be "late-resolved".
The second argument is a <em>ServiceRequest</em> instance that provides the requested service type and service name.</p>
<h3 id="ienumerablet">IEnumerable&lt;T&gt;</h3>
<p>When we register multiple services with the same service type, <strong>LightInject</strong> is capable of resolving these services as an  <a href="http://msdn.microsoft.com/en-us/library/9eekhta0.aspx">IEnumerable&lt;T&gt;</a>.</p>
<pre><code>public class Foo : IFoo {}
public class AnotherFoo : IFoo {}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Register&lt;IFoo, AnotherFoo&gt;("AnotherFoo");
var instances = container.GetInstance&lt;IEnumerable&lt;IFoo&gt;&gt;()
Assert.AreEqual(2, instances.Count());
</code></pre>
<p>Alternatively using the <strong>GetAllInstances</strong> method.</p>
<pre><code>var instances = container.GetAllInstances&lt;IFoo&gt;();
Assert.AreEqual(2, instances.Count());
</code></pre>
<p>In addition, <strong>LightInject</strong> supports the following <a href="http://msdn.microsoft.com/en-us/library/9eekhta0.aspx">IEnumerable&lt;T&gt;</a> sub-types. </p>
<ul>
<li>Array</li>
<li>ICollection&lt;T&gt;</li>
<li>IList&lt;T&gt;</li>
<li>IReadOnlyCollection&lt;T&gt; (Net 4.5 and Windows Runtime);</li>
<li>IReadOnlyList&lt;T&gt; (Net 4.5 and Windows Runtime)</li>
</ul>
<p>By default, <strong>LightInject</strong> will resolve all services that are compatible with the requested element type.</p>
<pre><code>container.Register&lt;Foo&gt;();
container.Register&lt;DerivedFoo&gt;();
var instances = container.GetAllInstances&lt;Foo&gt;();
Assert.AreEqual(2, instances.Count());
</code></pre>
<p>This behavior can be overridden using the <strong>EnableVariance</strong> container option.</p>
<pre><code>var container = new ServiceContainer(new ContainerOptions { EnableVariance = false });
container.Register&lt;Foo&gt;();
container.Register&lt;DerivedFoo&gt;();
var instances = container.GetAllInstances&lt;Foo&gt;();
Assert.AreEqual(1, instances.Count());
</code></pre>
<p>We can also selectively decide to apply variance only for certain <code>IEnumerable&lt;T&gt;</code> services.</p>
<pre><code class="C#">options.VarianceFilter = (enumerableType) =&gt; enumerableType.GetGenericArguments()[0] == typeof(IFoo);
</code></pre>

<h4 id="ordering">Ordering</h4>
<p>Sometimes the ordering of the resolved services are important and <strong>LightInject</strong> solves this by ordering services by their service name.</p>
<pre><code class="c#">container.Register&lt;IFoo, Foo1&gt;(&quot;A&quot;);
container.Register&lt;IFoo, Foo2&gt;(&quot;B&quot;);
container.Register&lt;IFoo, Foo3&gt;(&quot;C&quot;);

var instances = container.GetAllInstances&lt;IFoo&gt;().ToArray();
Assert.IsType&lt;Foo1&gt;(instances[0]);
Assert.IsType&lt;Foo2&gt;(instances[1]);
Assert.IsType&lt;Foo3&gt;(instances[2]);
</code></pre>

<p>We can also register multiple implementations for a given service type using the <code>RegisterOrdered</code> method.</p>
<pre><code class="c#">var container = CreateContainer();
container.RegisterOrdered(typeof(IFoo), new[] {typeof(Foo1), typeof(Foo2), typeof(Foo3)},
    type =&gt; new PerContainerLifetime());

var instances = container.GetAllInstances&lt;IFoo&gt;().ToArray();

Assert.IsType&lt;Foo1&gt;(instances[0]);
Assert.IsType&lt;Foo2&gt;(instances[1]);
Assert.IsType&lt;Foo3&gt;(instances[2]);
</code></pre>

<p>The <code>RegisterOrdered</code> method gives each implementation a service name that can be used for ordering when resolving these services. By default the service name is formatted like <code>001</code>, <code>002</code> and so on. 
If we need so change this convention, we can do this by passing a format function to the <code>RegisterOrdered</code> method.</p>
<pre><code class="c#">container.RegisterOrdered(typeof(IFoo&lt;&gt;), new[] { typeof(Foo1&lt;&gt;), typeof(Foo2&lt;&gt;), typeof(Foo3&lt;&gt;) },
    type =&gt; new PerContainerLifetime(), i =&gt; $&quot;A{i.ToString().PadLeft(3,'0')}&quot;);

var services = container.AvailableServices.Where(sr =&gt; sr.ServiceType == typeof(IFoo&lt;&gt;))
    .OrderBy(sr =&gt; sr.ServiceName).ToArray();
Assert.Equal(&quot;A001&quot;, services[0].ServiceName);
Assert.Equal(&quot;A002&quot;, services[1].ServiceName);
Assert.Equal(&quot;A003&quot;, services[2].ServiceName);
</code></pre>

<h3 id="values">Values</h3>
<p>Registers the value as a constant.</p>
<pre><code>container.RegisterInstance&lt;string&gt;("SomeValue");
var value = container.GetInstance&lt;string&gt;();
Assert.AreEqual("SomeValue, value);
</code></pre>
<h3 id="compilation">Compilation</h3>
<p><strong>LightInject</strong> uses dynamic code compilation either in the form of System.Reflection.Emit or compiled expression trees. When a service is requested from the container, the code needed for creating the service instance is generated and compiled and a delegate for that code is stored for lookup later on so that we only compile it once. These delegates are stored in an AVL tree that ensures maximal performance when looking up a delegate for a given service type. If fact, looking up these delegates is what sets the top performing containers apart. Most high performance container emits approximately the same code, but the approach to storing these delegates may differ. </p>
<p><strong>LightInject</strong> provides lock-free service lookup meaning that no locks are involved for getting a service instance after its initial generation and compilation. The only time <strong>LightInject</strong> actually creates a lock is when generating the code for a given service.  That does however mean a potential lock contention problem when many concurrent requests asks for services for the first time.</p>
<p><strong>LightInject</strong> deals with this potential problem by providing an API for compilation typically used when an application starts.</p>
<p>The following example shows how to compile all registered services.</p>
<pre><code class="c#">container.Compile();
</code></pre>

<p>One thing to be aware of is that not all services are backed by its own delegate. </p>
<p>Consider the following service:</p>
<pre><code class="c#">public class Foo
{
    public Foo(Bar bar)
    {
        Bar = bar;
    }
} 
</code></pre>

<p>Registered and resolved like this:</p>
<pre><code class="c#">container.Register&lt;Foo&gt;();
container.Register&lt;Bar&gt;();
var foo = container.GetInstance&lt;Foo&gt;();
</code></pre>

<p>In this case we only create a delegate for resolving <code>Foo</code> since that is the only service that is directly requested from the container. The code for creating the <code>Bar</code> instance is embedded inside the code for creating the <code>Foo</code> instance and hence there is only one delegate created.</p>
<p>We call <code>Foo</code> a root service since it is directly requested from the container. </p>
<p>In fact lets just have a look at the IL generated for creating the <code>Foo</code> instance. </p>
<pre><code class="assembly">newobj Void .ctor() // Bar
newobj Void .ctor(LightInject.SampleLibrary.IBar) //Foo
</code></pre>

<p>What happens here is that a new instance of <code>Bar</code> is created and pushed onto the stack and then we create the <code>Foo</code> instance. This is the code that the delegate for <code>Foo</code> points to. </p>
<p>The reason for such a relatively detailed explanation is to illustrate that we don't always create a delegate for a given service and by simply doing a <code>container.Compile()</code> we might create a lot of delegates that is never actually executed.  Probably no big deal as long as we don't have tens of thousands of services, but just something to be aware of.</p>
<p><strong>LightInject</strong> does not attempt to identify root services as that would be very difficult for various reasons.</p>
<p>We can instead use a predicate when compiling services up front.</p>
<pre><code class="C#">container.Compile(sr =&gt; sr.ServiceType == typeof(Foo));
</code></pre>

<h4 id="open-generics">Open Generics</h4>
<p><strong>LightInject</strong> cannot compile open generic services since the actual generic arguments are not known at "compile" time. </p>
<p>We can however specify the generic arguments like this:</p>
<pre><code class="c#">container.Compile&lt;Foo&lt;int&gt;&gt;()
</code></pre>

<p><strong>LightInject</strong> will create a log entry every time a new delegate is created so that information can be used to identify root services that could be compiled up front. In addition to this, a log entry (warning) is also created when trying to compile an open generic service up front.</p>
<h2 id="lifetime">Lifetime</h2>
<p>The default behavior in <strong>LightInject</strong> is to treat all objects as transients unless otherwise specified.</p>
<pre><code>container.Register&lt;IFoo,Foo&gt;();
var firstInstance = container.GetInstance&lt;IFoo&gt;();
var secondInstance = container.GetInstance&lt;IFoo&gt;();
Assert.AreNotSame(firstInstance, secondInstance);
</code></pre>
<h3 id="perscopelifetime">PerScopeLifetime</h3>
<p>Ensures that only one instance of a given service can exists within a scope.
The container will call the <strong>Dispose</strong> method on all disposable objects created within the scope.</p>
<pre><code>container.Register&lt;IFoo,Foo&gt;(new PerScopeLifetime());
using(container.BeginScope())
{

    var firstInstance = container.GetInstance&lt;IFoo&gt;();
    var secondInstance = container.GetInstance&lt;IFoo&gt;();
    Assert.AreSame(firstInstance, secondInstance);
}
</code></pre>
<p><strong>Note:</strong> <em>An <strong>InvalidOperationException</strong> is thrown if a service registered with the <strong>PerScopeLifetime</strong> is requested outside the scope.</em></p>
<h3 id="percontainerlifetime">PerContainerLifetime</h3>
<p>Ensures that only one instance of a given service can exist within the container.
The container will call the Dispose method on all disposable objects when the container itself is disposed.</p>
<pre><code>using(container = new ServiceContainer())
{
    container.Register&lt;IFoo,Foo&gt;(new PerContainerLifetime());   
    var firstInstance = container.GetInstance&lt;IFoo&gt;();
    var secondInstance = container.GetInstance&lt;IFoo&gt;();
    Assert.AreSame(firstInstance, secondInstance);
}
</code></pre>
<h3 id="perrequestlifetime">PerRequestLifeTime</h3>
<p>A new instance is created for each request and the container calls <strong>Dispose</strong> when the scope ends.
This lifetime is used when the conrete class implements <strong>IDisposable</strong>.</p>
<pre><code>container.Register&lt;IFoo,Foo&gt;(new PerRequestLifeTime());
using(container.BeginScope())
{       
    var firstInstance = container.GetInstance&lt;IFoo&gt;();
    var secondInstance = container.GetInstance&lt;IFoo&gt;();
    Assert.AreNotSame(firstInstance, secondInstance);
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> <em>An <strong>InvalidOperationException</strong> is thrown if a service registered with the <strong>PerRequestLifeTime</strong> is requested outside the scope.</em></p>
</blockquote>
<h3 id="custom-lifetime">Custom lifetime</h3>
<p>A custom lifetime is created by implementing the <strong>ILifetime</strong> interface</p>
<pre><code>internal interface ILifetime
{
    object GetInstance(Func&lt;object&gt; instanceFactory, Scope currentScope);        
}
</code></pre>
<p>The following example shows to create a custom lifetime that ensures only one instance per thread.</p>
<pre><code>public class PerThreadLifetime : ILifetime
{
    ThreadLocal&lt;object&gt; instances = new ThreadLocal&lt;object&gt;();

    public object GetInstance(Func&lt;object&gt; instanceFactory, Scope currentScope)
    {
        if (instances.value == null)
        {
            instances.value = instanceFactory();
        }
        return instances.value;
    }
}
</code></pre>
<p>That is all it takes to create a custom lifetime, but what about disposable services?</p>
<pre><code>public class PerThreadLifetime : ILifetime
{
    ThreadLocal&lt;object&gt; instances = new ThreadLocal&lt;object&gt;();

    public object GetInstance(Func&lt;object&gt; instanceFactory, Scope currentScope)
    {           
        if (instances.value == null)
        {               
            object instance = instanceFactory();                
            IDisposable disposable = instance as IDisposable;               
            if (disposable != null)
            {
                if (currentScope == null)
                {
                    throw new InvalidOperationException("Attempt to create an disposable object 
                                                        without a current scope.")
                }
                currentScope.TrackInstance(disposable);
            }

            instances.value = instance;
        }
        return instance.value;
    }
}
</code></pre>
<h4 id="important">Important</h4>
<p>A lifetime object controls the lifetime of a single service and can <strong>never</strong> be shared for multiple service registrations.</p>
<p><strong>Wrong</strong></p>
<pre><code>ILifetime lifetime = new PerContainerLifeTime();
container.Register&lt;IFoo,Foo&gt;(lifetime);
container.Register&lt;IBar,Bar&gt;(lifetime);
</code></pre>
<p><strong>Right</strong></p>
<pre><code>container.Register&lt;IFoo,Foo&gt;(new PerContainerLifeTime());
container.Register&lt;IBar,Bar&gt;(new PerContainerLifeTime());
</code></pre>
<p>A lifetime object is also shared across threads and that is something we must take into consideration when developing new lifetime implementations.</p>
<h3 id="async-and-await">Async and Await</h3>
<p>By default scopes are managed per thread which means that when the container looks for the current scope, it will look for a scope that is associated with the current thread.</p>
<p>With the introduction of the async/await pattern chances are that the code that is requesting a service instance is running on another thread.</p>
<p>To illustrate this lets consider an example that is going to cause an instance to be resolved on another thread.</p>
<p>We start of by creating an interface that returns a <strong>Task&lt;IBar&gt;</strong></p>
<pre><code>public interface IAsyncFoo
{
    Task&lt;IBar&gt; GetBar();
}
</code></pre>
<p>Next we implement this interface in such a way that the <strong>IBar</strong> instance is requested on another thread.</p>
<pre><code>public class AsyncFoo : IAsyncFoo
{
    private readonly Lazy&lt;IBar&gt; lazyBar;

    public AsyncFoo(Lazy&lt;IBar&gt; lazyBar)
    {
        this.lazyBar = lazyBar;
    }

    public async Task&lt;IBar&gt; GetBar()
    {
        await Task.Delay(10);
        return lazyBar.Value; &lt;--This code is executed on another thread (continuation).
    }
}
</code></pre>
<p>The we register the dependency (<strong>IBar</strong>) with the <strong>PerScopeLifetime</strong> that is going to cause the container to ask for the current scope so that the instance can be registered with that scope.</p>
<pre><code>var container = new ServiceContainer();
container.Register&lt;IBar, Bar&gt;(new PerScopeLifetime());
container.Register&lt;IAsyncFoo, AsyncFoo&gt;();

using (container.BeginScope())
{
    var instance = container.GetInstance&lt;IAsyncFoo&gt;();
    ExceptionAssert.Throws&lt;AggregateException&gt;(() =&gt; instance.GetBar().Wait());                
}
</code></pre>
<p>This will throw an exception that states the following:</p>
<pre><code>Attempt to create a scoped instance without a current scope.
</code></pre>
<p>The reason that this is happening is that the current scope is associated with the thread that created it and when the continuation executes, we are essentially requesting an instance on another thread.</p>
<p>To deal with this issue, <strong>LightInject</strong> now supports scopes across the logical <a href="http://msdn.microsoft.com/en-us/library/system.runtime.remoting.messaging.callcontext(v=vs.110).aspx">CallContext</a>.  </p>
<pre><code>var container = new ServiceContainer();
container.ScopeManagerProvider = new PerLogicalCallContextScopeManagerProvider();
container.Register&lt;IBar, Bar&gt;(new PerScopeLifetime());
container.Register&lt;IAsyncFoo, AsyncFoo&gt;();

using (container.BeginScope())
{
    var instance = container.GetInstance&lt;IAsyncFoo&gt;();
    var bar = instance.GetBar().Result;
    Assert.IsInstanceOfType(bar, typeof(IBar));
}
</code></pre>
<blockquote>
<p>Note that the <strong>PerLogicalCallContextScopeManagerProvider</strong> is only available when running under .Net 4.5.
For more information, please refer to the following <a href="http://blog.stephencleary.com/2013/04/implicit-async-context-asynclocal.html">article</a> by Stephen Cleary.</p>
</blockquote>
<h2 id="dependencies">Dependencies</h2>
<h3 id="constructor-injection">Constructor Injection</h3>
<pre><code>public interface IFoo {}        
public interface IBar {}

public class Foo : IFoo
{
    public Foo(IBar bar) 
    {
        Bar = bar;
    }

    public IBar Bar { get; private set; } 
}

public class Bar : IBar {}
</code></pre>
<h4 id="implicit-service-registration">Implicit service registration</h4>
<p>Registers a service without specifying any information about how to resolve the constructor dependencies of the implementing type.</p>
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Register&lt;IBar, Bar&gt;();
var foo = (Foo)container.GetInstance&lt;IFoo&gt;();
Assert.IsInstanceOfType(foo.Bar, typeof(Bar));
</code></pre>
<blockquote>
<p>Note: In the case where the implementing type(Foo) has more than one constructor, <strong>LightInject</strong> will choose the constructor with the most parameters. </p>
</blockquote>
<p>For fine grained control of the injected constructor dependencies, we can provide a factory that makes it possible to create an instance of a given constructor dependency.</p>
<pre><code>container.RegisterConstructorDependency&lt;IBar&gt;((factory, parameterInfo) =&gt; new Bar());
</code></pre>
<p>This tells the container to inject a new <strong>Bar</strong> instance whenever it sees an <strong>IBar</strong> constructor dependency.</p>
<h4 id="explicit-service-registration">Explicit service registration</h4>
<p>Registers a service by providing explicit information about how to create the service instance and how to resolve the constructor dependencies.
​  <br />
    container.Register<IBar, Bar>();
    container.Register<IFoo>(factory =&gt; new Foo(factory.GetInstance<IBar>));
    var foo = (Foo)container.GetInstance<IFoo>();
    Assert.IsNotNull(foo.Bar);            </p>
<h4 id="parameters">Parameters</h4>
<p>Parameters are used when we want to supply one or more values when the service is resolved.</p>
<pre><code>public class Foo : IFoo
{
    public Foo(int value)
    {
        Value = value;
    }

    public int Value { get; private set; }
}
</code></pre>
<hr />
<pre><code>container.Register&lt;int, IFoo&gt;((arg, factory) =&gt; new Foo(arg));
var foo = (Foo)container.GetInstance&lt;int, IFoo&gt;(42);
Assert.AreEqual(42,foo.Value);
</code></pre>
<p>We can also do a combination of supplied values and dependencies.</p>
<pre><code>public class Foo : IFoo
{
    public Foo(int value, IBar bar)
    {
        Value = value;
    }

    public int Value { get; private set; }
    public IBar Bar { get; private set; }
}
</code></pre>
<hr />
<pre><code>container.Register&lt;IBar, Bar&gt;();
container.Register&lt;int, IFoo&gt;((factory, value) =&gt; new Foo(value, factory.GetInstance&lt;IBar&gt;()));
var foo = (Foo)container.GetInstance&lt;int, IFoo&gt;(42);
Assert.AreEqual(42, foo.Value);
Assert.IsNotNull(foo.Bar);
</code></pre>
<h3 id="property-injection">Property Injection</h3>
<pre><code>public interface IFoo {}

public interface IBar {}

public class Foo : IFoo
{
    public IBar Bar { get; set; }
}

public class Bar : IBar {}
</code></pre>
<h4 id="implicit-service-registration_1">Implicit service registration</h4>
<p>Registers the service without specifying any information about how to resolve the property dependencies.</p>
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Register&lt;IBar, Bar&gt;();
var foo = (Foo)container.GetInstance&lt;IFoo&gt;();
Assert.IsNotNull(foo.bar);
</code></pre>
<blockquote>
<p><strong>Note:</strong> <strong><em>LightInject</em>* considers all read/write properties a dependency, but implements a loose strategy around property dependencies, meaning that it will </strong>NOT*<em> throw an exception in the case of an unresolved property dependency.</em>          </p>
</blockquote>
<p>For fine grained control of the injected property dependencies, we can provide a factory that makes it possible to create an instance of a given property dependency.</p>
<pre><code>container.RegisterPropertyDependency&lt;IBar&gt;((factory, propertyInfo) =&gt; new Bar());
</code></pre>
<p>This tells the container to inject a new <strong>Bar</strong> instance whenever it sees an <strong>IBar</strong> property dependency.</p>
<h4 id="explicit-service-registration_1">Explicit service registration</h4>
<p>Registers a service by providing explicit information about how to create the service instance and how to resolve the property dependencies.</p>
<pre><code>container.Register&lt;IBar, Bar&gt;();
container.Register&lt;IFoo&gt;(factory =&gt; new Foo() {Bar = factory.GetInstance&lt;IBar&gt;()}) 
var foo = (Foo)container.GetInstance&lt;IFoo&gt;();
Assert.IsNotNull(foo.bar);
</code></pre>
<h4 id="property-injection-on-existing-instances">Property injection on existing instances.</h4>
<p>In the cases where we don't control the creation of the service instance, <strong>LightInject</strong> can inject property dependencies into an existing instance.</p>
<pre><code>container.Register&lt;IBar, Bar&gt;();
var foo = new Foo();
container.InjectProperties(foo);
Assert.IsNotNull(foo);
</code></pre>
<h4 id="disabling-properyinjection">Disabling ProperyInjection</h4>
<p>Property injection is enabled by default in <strong>LightInject</strong>, but it can be disabled like this.</p>
<pre><code class="c#">var container = new ServiceContainer(new ContainerOptions { EnablePropertyInjection = false });
</code></pre>

<blockquote>
<p>It is actually recommended to turn off property injection unless it is really needed. Backward compatibility is the only reason that this is not the default.</p>
</blockquote>
<h2 id="initializers">Initializers</h2>
<p>Use the <strong>Initialize</strong> method to perform service instance initialization/post-processing.  </p>
<pre><code>container.Register&lt;IFoo, FooWithPropertyDependency&gt;();
container.Initialize(registration =&gt; registration.ServiceType == typeof(IFoo), 
    (factory, instance) =&gt; ((FooWithPropertyDependency)instance).Bar = new Bar());
var foo = (FooWithProperyDependency)container.GetInstance&lt;IFoo&gt;();
Assert.IsInstanceOfType(foo.Bar, typeof(Bar));
</code></pre>
<h2 id="assembly-scanning">Assembly Scanning</h2>
<p>LightInject is capable of registering services by looking at the types of a given assembly.</p>
<pre><code class="c#">container.RegisterAssembly(typeof(IFoo).Assembly)
</code></pre>

<p>To filter out the services to be registered with the container, we can provide a predicate that makes it possible to inspect the service type and the implementing type.</p>
<pre><code class="c#">container.RegisterAssembly(typeof(IFoo).Assembly, (serviceType, implementingType) =&gt; serviceType.NameSpace == &quot;SomeNamespace&quot;);
</code></pre>

<p>It is also possible to scan a set assembly files based on a search pattern.</p>
<pre><code class="c#">container.RegisterAssembly(&quot;SomeAssemblyName*.dll&quot;);  
</code></pre>

<p>When scanning assemblies, <strong>LightInject</strong> will register services using a service name that by default is the implementing type name. This behavior can be changed by specifying a function delegate to provide the name based on the service type and the implementing type.</p>
<pre><code class="c#">container.RegisterAssembly(typeof(IFoo).Assembly, () =&gt; new PerContainerLifetime(), (serviceType, implementingType) =&gt; serviceType.NameSpace == &quot;SomeNamespace&quot;, (serviceType, implementingType) =&gt; &quot;Provide custom service name here&quot;);
</code></pre>

<p>We can also change this behavior globally for all registrations by implementing the <strong>IServiceNameProvider</strong> interface.</p>
<pre><code class="c#">public class CustomServiceNameProvider : IServiceNameProvider
{
    public string GetServiceName(Type serviceType, Type implementingType)
    {
        return &quot;Provide custom service name here&quot;;  
    }
}
</code></pre>

<p>To change the default behavior for all registrations we simply change this dependency on the container before we start scanning assemblies.</p>
<pre><code class="c#">container.ServiceNameProvider = new CustomServiceNameProvider();
</code></pre>

<h2 id="composition-root">Composition Root</h2>
<p>When <strong>LightInject</strong> scans an assembly it will look for an implementation of the <strong>ICompositionRoot</strong> interface.   </p>
<pre><code>public class SampleCompositionRoot : ICompositionRoot
{               
    public void Compose(IServiceRegistry serviceRegistry)
    {     
        serviceRegistry.Register(typeof(IFoo),typeof(Foo));
    }
}
</code></pre>
<p>If one or more implementations of the <strong>ICompositionRoot</strong> interface is found, they will be created and executed.</p>
<blockquote>
<p><strong>Note:</strong> <em>Any other services contained within the target assembly that is not registered in the composition root, will <strong>NOT</strong> be registered.</em></p>
</blockquote>
<p>Rather that having a single composition root that basically needs to reference all other assemblies, having multiple composition roots makes it possible to group services naturally together. Another advantage of registering services in a <strong>ICompositionRoot</strong>, is that they can easily be reused in automated tests.   </p>
<h3 id="lazy-composition-roots">Lazy Composition Roots</h3>
<p><strong>LightInject</strong> is capable of registering services on a need to have basis. For a large application that has a lot of services, it might not be the best solution to register all these services up front as this could seriously hurt the startup time of our application due to extensive assembly loading.</p>
<p>If an unregistered service is requested, <strong>LightInject</strong> will scan the assembly where this service is contained.  </p>
<h3 id="compositionrootattribute">CompositionRootAttribute</h3>
<p>When an assembly is being scanned, <strong>LightInject</strong> will look for implementations of the <strong>ICompositionRoot</strong> interface. For large assemblies that contains many type, this might be an expensive operation. The <strong>CompositionRootAttribute</strong> is an assembly level attribute that simply helps <strong>LightInject</strong> to locate the compostion root.</p>
<pre><code>[assembly: CompositionRootType(typeof(SampleCompositionRoot))]
</code></pre>
<h3 id="registerfrom">RegisterFrom</h3>
<p>Allows explicit execution of a composition root.</p>
<pre><code>container.RegisterFrom&lt;SampleCompositionRoot&gt;();
</code></pre>
<h2 id="generics">Generics</h2>
<pre><code>public interface IFoo&lt;T&gt; {};
public class Foo&lt;T&gt; : IFoo&lt;T&gt; {};
</code></pre>
<p>The container creates the closed generic type based on the service request.
​  <br />
    container.Register(typeof(IFoo&lt;&gt;), typeof(Foo&lt;&gt;));
    var instance = container.GetInstance(typeof(IFoo<int>));
    Assert.IsInstanceOfType(instance, typeof(Foo<int>));</p>
<h3 id="constraints">Constraints</h3>
<p><strong>LightInject</strong> enforces generic constrains  </p>
<h2 id="lazyt">Lazy&lt;T&gt;</h2>
<p><strong>LightInject</strong> can resolve a service as an instance of <a href="http://msdn.microsoft.com/en-us/library/dd642331.aspx">Lazy&lt;T&gt;</a> when we want to postpone resolving the underlying service until it is needed.</p>
<pre><code>public interface IFoo {}
public class Foo : IFoo {}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo, Foo&gt;();
var lazyFoo = container.GetInstance&lt;Lazy&lt;IFoo&gt;&gt;();
Assert.IsNotNull(lazyFoo.Value);
</code></pre>
<h2 id="function-factories">Function Factories</h2>
<p>Function factories allows services to resolved as a function delegate that in turn is capable of returning the underlying service instance. We can think of this as an alternative to the <a href="http://en.wikipedia.org/wiki/Service_locator_pattern">Service Locator</a> (anti)pattern.</p>
<pre><code>public interface IFoo {}
public class Foo : IFoo {}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo,Foo&gt;();
var func = container.GetInstance&lt;Func&lt;IFoo&gt;&gt;();
var foo = func();
Assert.IsNotNull(foo);
</code></pre>
<blockquote>
<p><strong>Note:</strong> <em>A function factory is effectively a delegate that redirects back to the corresponding <strong>GetInstance</strong> method on the service container.</em></p>
</blockquote>
<h3 id="named-factories">Named Factories</h3>
<p>The container returns a function delegate that represents calling the <strong>GetInstance</strong> method with "SomeFoo" as the service name argument.</p>
<pre><code>container.Register&lt;IFoo, Foo&gt;("SomeFoo");
var func = container.GetInstance&lt;Func&lt;IFoo&gt;&gt;("SomeFoo");   
var foo = func();
Assert.IsNotNull(foo);
</code></pre>
<h3 id="parameters_1">Parameters</h3>
<p>Function factories can also take parameters that will be used create the service instance.</p>
<pre><code>public class Foo : IFoo
{
    public Foo(int value)
    {
        Value = value;
    }

    public int Value { get; private set; }
}
</code></pre>
<hr />
<pre><code>container.Register&lt;int, IFoo&gt;((factory, value) =&gt; new Foo(value));
var fooFactory = container.GetInstance&lt;Func&lt;int, IFoo&gt;&gt;();
var foo = (Foo)fooFactory(42); 
Assert.AreEqual(foo.Value, 42);
</code></pre>
<blockquote>
<p><strong>Note</strong> : <em>The service must be explicitly registered in order for the container to resolve it as a parameterized function factory.</em></p>
</blockquote>
<h3 id="idisposable">IDisposable</h3>
<p>The only way to deal with disposable objects when using function factories, is to let the service type inherit from IDisposable.</p>
<pre><code>public interface IFoo : IDisposable {}
public class Foo : IFoo {}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo, Foo&gt;();
var fooFactory = container.GetInstance&lt;Func&lt;IFoo&gt;&gt;();

using(IFoo foo = fooFactory())
{

} &lt;--Instance is disposed here
</code></pre>
<blockquote>
<p><strong>Note:</strong> <em>Although this is common practice even in the <a href="http://en.wikipedia.org/wiki/Base_Class_Library">BCL</a>, this kind of interfaces are often referred to as <a href="http://en.wikipedia.org/wiki/Leaky_abstraction">leaky abstractions</a>.</em></p>
</blockquote>
<h2 id="typed-factories">Typed Factories</h2>
<p>A typed factory is a class that wraps the function factory that is used to create the underlying service instance.
As opposed to just function factories, typed factories provides better expressiveness to the consumer of the factory. <br />
​  <br />
    public interface IFooFactory
    {
        IFoo GetFoo();
    }</p>
<hr />
<pre><code>public class FooFactory : IFooFactory
{
    private Func&lt;IFoo&gt; createFoo;

    public FooFactory(Func&lt;IFoo&gt; createFoo)
    {
        this.createFoo = createFoo;
    }

    public IFoo GetFoo()
    {
        return createFoo();
    }
}
</code></pre>
<hr />
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Register&lt;IFooFactory, FooFactory&gt;(new PerContainerLifetime());
var fooFactory = container.GetInstance&lt;IFooFactory&gt;();
var foo = fooFactory.GetFoo();
Assert.IsNotNull(foo);
</code></pre>
<blockquote>
<p><strong>Note:</strong> <em>Register typed factories with the <strong>PerContainerLifetime</strong> unless a compelling reason exists to choose a different lifetime.</em>  </p>
</blockquote>
<h3 id="parameters_2">Parameters</h3>
<p>Types factories can also wrap a parameterized function factory and allows us to pass arguments.</p>
<pre><code>public class Foo : IFoo
{
    public Foo(int value)
    {
        Value = value;
    }

    public int Value { get; private set; }
}

public interface IFooFactory
{
    IFoo GetFoo(int value);
}
</code></pre>
<hr />
<pre><code>public class FooFactory : IFooFactory
{
    private Func&lt;int, IFoo&gt; createFoo;

    public FooFactory(Func&lt;int, IFoo&gt; createFoo)
    {
        this.createFoo = createFoo;
    }

    public IFoo GetFoo(int value)
    {
        return createFoo(value);
    }
}
</code></pre>
<hr />
<pre><code>container.Register&lt;int, IFoo&gt;((factory, value) =&gt; new Foo(value));
container.Register&lt;IFooFactory, FooFactory&gt;(new PerContainerLifetime());
var typedFooFactory = container.GetInstance&lt;IFooFactory&gt;();
var foo = typedFooFactory.GetFoo(42);
Assert.AreEqual(foo.Value, 42);
</code></pre>
<h3 id="idisposable_1">IDisposable</h3>
<p>Working with typed factories gives us the possibility to release disposable services registered as transients without exposing a leaky abstraction.</p>
<pre><code>public interface IFooFactory
{
    IFoo GetFoo(int value);
    void Release(IFoo foo);
}
</code></pre>
<hr />
<pre><code>public class FooFactory : IFooFactory
{
    private Func&lt;IFoo&gt; createFoo;

    public FooFactory(Func&lt;IFoo&gt; createFoo)
    {
        this.createFoo = createFoo;
    }

    public IFoo GetFoo(int value)
    {
        return createFoo(value);
    }

    public void Release(IFoo foo)
    {
        var disposable = foo as IDisposable;
        if (disposable != null)
        {
            disposable.Dispose();
        }
    }
}
</code></pre>
<h2 id="recursive-dependency-detection">Recursive dependency detection</h2>
<p>A recursive dependency graph is when a service depends directly or indirectly on itself.</p>
<pre><code>public class FooWithRecursiveDependency : IFoo
{
    public FooWithRecursiveDependency(IFoo foo)
    {
    }
}
</code></pre>
<p>The following code will throw an <strong>InvalidOperationException</strong> stating that there are existing recursive dependencies. </p>
<pre><code>container.Register(typeof(IFoo), typeof(FooWithRecursiveDependency));
container.GetInstance&lt;IFoo&gt;()
</code></pre>
<h2 id="internals">Internals</h2>
<p>When running under the .Net platform, <strong>LightInject</strong> is capable of creating instances of classes that has the <a href="http://msdn.microsoft.com/en-us/library/7c5ka91b.aspx">internal</a> modifier. </p>
<p>The only requirement is that the internal class exposes a public constructor.</p>
<pre><code>internal class InternalFooWithPublicConstructor : IFoo
{
    public InternalFooWithPublicConstructor () {}
}
</code></pre>
<h2 id="logging">Logging</h2>
<p>Sometimes it might be useful to obtain information about what is going on inside the container 
and <strong>LightInject</strong> provides a very simple log abstraction that is used to log information and warnings from within the container.</p>
<pre><code class="csharp">var containerOptions = new ContainerOptions();
containerOptions.LogFactory = (type) =&gt; logEntry =&gt; Console.WriteLine(logEntry.Message);
</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="designpatterns/" title="Patterns" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Patterns
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
    
      
    
  </body>
</html>