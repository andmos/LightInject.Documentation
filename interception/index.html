



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.1.0">
    
    
      
        <title>Interception - LightInject</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.11e41852.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#interception" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="LightInject" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                LightInject
              </span>
              <span class="md-header-nav__topic">
                Interception
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="LightInject" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    LightInject
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/seesharper/lightinject/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../designpatterns/" title="Patterns" class="md-nav__link">
      Patterns
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Extensions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Extensions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Interception
      </label>
    
    <a href="./" title="Interception" class="md-nav__link md-nav__link--active">
      Interception
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary" title="Binary" class="md-nav__link">
    Binary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source" title="Source" class="md-nav__link">
    Source
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interceptors" title="Interceptors" class="md-nav__link">
    Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-interceptors" title="Asynchronous Interceptors" class="md-nav__link">
    Asynchronous Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-interceptor" title="Single Interceptor" class="md-nav__link">
    Single Interceptor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" title="Dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiple-interceptors" title="Multiple Interceptors" class="md-nav__link">
    Multiple Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-selectors" title="Method Selectors" class="md-nav__link">
    Method Selectors
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extension-methods" title="Extension Methods" class="md-nav__link">
    Extension Methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chaining-interceptors" title="Chaining Interceptors" class="md-nav__link">
    Chaining Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-additional-interfaces" title="Implementing additional interfaces" class="md-nav__link">
    Implementing additional interfaces
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iproxy" title="IProxy" class="md-nav__link">
    IProxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this" title="This" class="md-nav__link">
    This
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#class-proxies" title="Class Proxies" class="md-nav__link">
    Class Proxies
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../autofactory/" title="AutoFactory" class="md-nav__link">
      AutoFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../annotation/" title="Annotation" class="md-nav__link">
      Annotation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Integrations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Integrations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../xunit/" title="xUnit" class="md-nav__link">
      xUnit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../web/" title="Web" class="md-nav__link">
      Web
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../mvc/" title="Mvc" class="md-nav__link">
      Mvc
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../wcf/" title="WCF" class="md-nav__link">
      WCF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../webapi/" title="Web Api" class="md-nav__link">
      Web Api
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../signalr/" title="SignalR" class="md-nav__link">
      SignalR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nancy/" title="Nancy" class="md-nav__link">
      Nancy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../microsoft.aspnetcore.hosting/" title="AspNetCore" class="md-nav__link">
      AspNetCore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../microsoft.dependencyinjection/" title="Microsoft DI" class="md-nav__link">
      Microsoft DI
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../webapirequestlogging/" title="Web Api Request Logging" class="md-nav__link">
      Web Api Request Logging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../transactions/" title="Transactions and Testing" class="md-nav__link">
      Transactions and Testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../aspnetcoreunittesting/" title="AspNetCore unit testing" class="md-nav__link">
      AspNetCore unit testing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../blog-dotnet-steps/" title="Reflection in C# scripts" class="md-nav__link">
      Reflection in C# scripts
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Side Projects
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Side Projects
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../lightmock/" title="LightMock" class="md-nav__link">
      LightMock
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../licence/" title="Licence" class="md-nav__link">
      Licence
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary" title="Binary" class="md-nav__link">
    Binary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#source" title="Source" class="md-nav__link">
    Source
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interceptors" title="Interceptors" class="md-nav__link">
    Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-interceptors" title="Asynchronous Interceptors" class="md-nav__link">
    Asynchronous Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-interceptor" title="Single Interceptor" class="md-nav__link">
    Single Interceptor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dependencies" title="Dependencies" class="md-nav__link">
    Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiple-interceptors" title="Multiple Interceptors" class="md-nav__link">
    Multiple Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#method-selectors" title="Method Selectors" class="md-nav__link">
    Method Selectors
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extension-methods" title="Extension Methods" class="md-nav__link">
    Extension Methods
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chaining-interceptors" title="Chaining Interceptors" class="md-nav__link">
    Chaining Interceptors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-additional-interfaces" title="Implementing additional interfaces" class="md-nav__link">
    Implementing additional interfaces
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iproxy" title="IProxy" class="md-nav__link">
    IProxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this" title="This" class="md-nav__link">
    This
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#class-proxies" title="Class Proxies" class="md-nav__link">
    Class Proxies
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/seesharper/lightinject/edit/master/docs/interception.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <p><a href=""><img alt="AppVeyor" src="https://img.shields.io/appveyor/ci/seesharper/lightinject-interception.svg?maxAge=2592000" /></a>
<a href=""><img alt="NuGet" src="https://img.shields.io/nuget/v/LightInject.Interception.svg?maxAge=2592000" /></a>
<a href=""><img alt="GitHub tag" src="https://img.shields.io/github/tag/seesharper/lightinject.interception.svg?maxAge=2592000" /></a></p>
<h1 id="interception">Interception</h1>
<p><strong>LightInject</strong> supports <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">Aspect Oriented Programming</a> through proxy-based method interceptors. </p>
<h2 id="installing">Installing</h2>
<p><strong>LightInject.Interception</strong> provides two distribution models via NuGet</p>
<h3 id="binary">Binary</h3>
<div class="nuget-badge" >
   <p>
         <code>PM&gt; Install-Package LightInject.Interception </code>
   </p>
</div>

<p>This adds a reference to the LightInject.Interception.dll in the target project.</p>
<h3 id="source">Source</h3>
<div class="nuget-badge" >
   <p>
         <code>PM&gt; Install-Package LightInject.Interception.Source </code>
   </p>
</div>

<p>This will install a single file (LightInject.Interception.cs) into the current project.</p>
<h2 id="interceptors">Interceptors</h2>
<p>An interceptor sits between the call site and the target instance and intercepts method calls.</p>
<pre><code>public class SampleInterceptor : IInterceptor
{
    public object Invoke(IInvocationInfo invocationInfo)
    {
        // Perform logic before invoking the target method
        var returnValue = invocationInfo.Proceed();
        // Perform logic after invoking the target method
        return returnValue;           
    }        
}
</code></pre>

<p>The <strong>IInvocationInfo</strong> instance passed into the <strong>Invoke</strong> method contains information about the method being intercepted.</p>
<p>The <strong>Proceed</strong> method calls down the chain of interceptors and ultimately the actual target instance.   </p>
<h2 id="asynchronous-interceptors">Asynchronous Interceptors</h2>
<p>When intercepting asynchronous methods we need to be able to await the target method.
This can be done by inheriting from the abstract <strong>AsyncInterceptor</strong> class that does the heavy lifting with invoking the asynchronous wrapper methods.
The <strong>AsyncInterceptor</strong> class is a decorator that wraps around another <strong>IInterceptor</strong>. </p>
<pre><code class="csharp">public class SampleAsyncInterceptor : AsyncInterceptor
{    
    public SampleAsyncInterceptor(IInterceptor targetInterceptor) : base(targetInterceptor)
    {
    }

    protected override async Task InvokeAsync(IInvocationInfo invocationInfo)
    {
        InterceptedTaskMethod = true;
        // Before method invocation
        await base.InvokeAsync(invocationInfo);
        // After method invocation
    }

    protected override async Task&lt;T&gt; InvokeAsync&lt;T&gt;(IInvocationInfo invocationInfo)
    {
        InterceptedTaskOfTMethod = true;
        // Before method invocation
        var value = await base.InvokeAsync&lt;T&gt;(invocationInfo);
        // After method invocation           
        return value;
    }
}
</code></pre>

<blockquote>
<p>Note: Do not call invocationInfo.Proceed() directly when inheriting from the <strong>AsyncInterceptor</strong> class. </p>
</blockquote>
<p>We can now create a new instance of the <strong>SampleAsyncInterceptor</strong> class like this:</p>
<pre><code class="csharp">var asyncInterceptor = new SampleAsyncInterceptor(new SampleInterceptor());
</code></pre>

<p>Another option is to register our <strong>IInterceptor</strong> with the container and use the <strong>Decorate</strong> method 
to apply the <strong>SampleAsyncInterceptor</strong> as a decorator.</p>
<pre><code class="csharp">container.Register&lt;IInterceptor, SampleInterceptor&gt;();
container.Decorate&lt;IInterceptor, SampleAsyncInterceptor&gt;();
container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), factory =&gt; factory.GetInstance&lt;IInterceptor&gt;()); 
</code></pre>

<blockquote>
<p>Note: Only synchronous methods are passed down to the decorated <strong>IInterceptor</strong> </p>
</blockquote>
<h2 id="single-interceptor">Single Interceptor</h2>
<p>This example shows how to configure the service container with a single interceptor to handle all method calls.</p>
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), sf =&gt; new SampleInterceptor());

var instance = container.GetInstance&lt;IFoo&gt;();
</code></pre>
<p>The instance returned is a proxy object that forwards method calls to the <strong>SampleInterceptor</strong> class.</p>
<p>The first parameter of the <strong>Intercept</strong> method is a selector function used to select the services that should have this interceptor applied.       <br />
The second parameter is a function delegate that used to create an <strong>IInterceptor</strong> instance. </p>
<p><strong>Note:</strong> <em>Proxy types are lazy in the sense that they will not create the target instance or any interceptors until the first method call is made.</em> </p>
<h2 id="dependencies">Dependencies</h2>
<p>Interceptors might also have dependencies and by resolving the interceptor through the container, those dependencies can be injected into the interceptor itself. </p>
<pre><code>public class SampleInterceptor : IInterceptor
{
    private IBar bar;

    public SampleInterceptor(IBar bar) 
    {
        this.bar = bar;    
    }

    public object Invoke(IInvocationInfo invocationInfo)

        // Perform logic using the injected dependency before invoking the target method             
        return invovationInfo.Proceed();                      
        // Perform logic using the injected dependency after invoking the target method
    }        
}
</code></pre>
<p>The following example shows how to configure the container so that the <strong>SampleInterceptor</strong> instance is resolved through the container.</p>
<pre><code>container.Register&lt;IFoo, Foo&gt;()
container.Register&lt;IBar, Bar&gt;();
container.Register&lt;IInterceptor, SampleInterceptor&gt;();
container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), sf =&gt; sf.GetInstance&lt;IInterceptor&gt;());
</code></pre>
<p><strong>Note:</strong> <em>When injecting depndencies into an interceptor we must make sure that the injected dependency is NOT intercepted by the same interceptor as this would cause a <strong>StackOverFlowException</strong>.</em>  </p>
<h2 id="multiple-interceptors">Multiple Interceptors</h2>
<p>Interceptors can be set up to handle a lot of cross cutting concerns such as logging, caching, null check and so on.
According to the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a>, we can separate the combined logic into a set of interceptor that each only does "one" thing.</p>
<p>We can do this by using another overload of the <strong>Intercept</strong> method that allows us to set up a <strong>ProxyDefinition</strong> instance that gives us more control over the proxy type that is being created.</p>
<pre><code>container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), (sf,pd) =&gt;  DefineProxyType(pd));

private void DefineProxyType(ProxyDefinition proxyDefinition)
{
    proxyDefinition.Implement(new FirstInterceptor());
    proxyDefinition.Implement(new SecondInterceptor());
}
</code></pre>
<p><strong>Note:</strong> <em>The interceptors are invoked in the same order as they are registered with the <strong>Implement</strong> method.</em></p>
<h2 id="method-selectors">Method Selectors</h2>
<p>Method selectors are used to select the methods that should be intercepted by an interceptor.</p>
<p>The following example shows how to set up the container so that only calls method <strong>A</strong> is passed to the interceptor.</p>
<pre><code>container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), (sf, pd) =&gt;  DefineProxyType(pd));

private void DefineProxyType(ProxyDefinition proxyDefinition)
{
    proxyDefinition.Implement(() =&gt; new SampleInterceptor(), m =&gt; m.Name == "SomeMethodName");       
}
</code></pre>
<p>Methods that does not match the method selector predicate will NOT be intercepted and method calls will be passed directly down to the target instance.  </p>
<p>If we omit the method selector, <strong>LightInject</strong> will intercept all methods from the target type and any additional interface, except methods that are inherited from <a href="http://msdn.microsoft.com/en-us/library/system.object.aspx">System.Object</a>.    </p>
<ul>
<li>Equals(Object)</li>
<li>GetHashCode</li>
<li>GetType</li>
<li>ToString</li>
</ul>
<p>If we choose to use a method selector, these methods will also be intercepted if they match the predicate in the method selector.</p>
<pre><code>proxyDefinition.Implement(() =&gt; new SampleInterceptor(), m =&gt; m.IsDeclaredBy&lt;object&gt;());
</code></pre>
<p>We can also use a method selector with the <strong>Intercept</strong> method that allows easy interception of any method without implementing an <strong>IInterceptor</strong>.</p>
<pre><code>container.Intercept(m =&gt; m.Name == "SomeMethodName", invocationInfo =&gt; invocationInfo.Proceed());
</code></pre>
<h3 id="extension-methods">Extension Methods</h3>
<p>LightInject provides a set of extension method that simplifies method selector predicates.</p>
<ul>
<li>IsPropertySetter - Returns <strong>true</strong> if the method represents a property setter, otherwise <strong>false</strong>. </li>
<li>IsPropertyGetter - Returns <strong>true</strong> if the method represents a property getter, otherwise <strong>false</strong>.</li>
<li>GetProperty - Returns the property for which the target method either represents the property getter or the property setter.</li>
</ul>
<h2 id="chaining-interceptors">Chaining Interceptors</h2>
<p>As already seen in the example with multiple interceptors,  we can chain interceptors together. We can also combine this with method selectors that will affect the call sequence from the call site down to the actual target instance.</p>
<p>Consider an interface with three methods.</p>
<pre><code>public interface IFoo 
{
    void A();
    void B();
    void C();
}
</code></pre>
<p>The following example shows how we can control the call sequence for each method.</p>
<pre><code>container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), (sf, pd) =&gt;  DefineProxyType(pd));

private void DefineProxyType(ProxyDefinition proxyDefinition)
{
    proxyDefinition.Implement(() =&gt; new FirstInterceptor(), m =&gt; m.Name == "A");
    proxyDefinition.Implement(() =&gt; new SecondInterceptor(), m =&gt; m.Name == "B");   
    proxyDefinition.Implement(() =&gt; new ThirdInterceptor(), m =&gt; m.Name == "A" || m.Name == "B" || m.Name == "C");
}
</code></pre>
<p><strong>Method A call sequence</strong></p>
<p>FirstInterceptor -&gt; ThirdInterceptor -&gt; Target </p>
<p><strong>Method B call sequence</strong></p>
<p>SecondInterceptor -&gt; ThirdInterceptor -&gt; Target</p>
<p><strong>Method C call sequence</strong></p>
<p>ThirdInterceptor -&gt; Target</p>
<h2 id="implementing-additional-interfaces">Implementing additional interfaces</h2>
<p>Another powerful feature of proxy objects is the ability to implement additional interfaces that is not implemented by the target type.</p>
<p>The <strong>Intercept</strong> method has an overload that lets us specify a set of interfaces to be implemented by the proxy type.</p>
<pre><code>container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), new []{ typeof(IBar) }, (sf, pd) =&gt;  DefineProxyType(pd));

private void DefineProxyType(ProxyDefinition proxyDefinition)
{
    proxyDefinition.Implement(() =&gt; new BarInterceptor(), m =&gt; m.IsDeclaredBy&lt;IBar&gt;());        
}
</code></pre>
<p>When implementing additional interfaces we must make sure that all methods are intercepted by either one or a combined set of interceptors. This is because we are now dealing with methods that does not exist in the target type and we must do all implementation through interceptors.  </p>
<h2 id="iproxy">IProxy</h2>
<pre><code>/// &lt;summary&gt;
/// Implemented by all proxy types.
/// &lt;/summary&gt;
public interface IProxy
{
    /// &lt;summary&gt;
    /// Gets the proxy target.
    /// &lt;/summary&gt;
    object Target { get; }
}
</code></pre>
<p>We can get to the underlying target instance through the <strong>IProxy</strong> interface</p>
<pre><code>container.Register&lt;IFoo, Foo&gt;();
container.Intercept(sr =&gt; sr.ServiceType == typeof(IFoo), sf =&gt; new SampleInterceptor());

var instance = container.GetInstance&lt;IFoo&gt;();
var actualTarget = ((IProxy)instance).Target;
</code></pre>
<h2 id="this">This</h2>
<p>One of the things to be aware of when working with proxy based interception is that it all relies on method calls being made through the proxy.
Method calls that are made directly to the target instance will NOT be intercepted. </p>
<pre><code>public interface IFoo
{
    void A();
}

public class Foo : IFoo
{
    public void A() {}

    private void B()
    {
        //Calls the target (this) directly and interceptors are not invoked.
        this.A();
    }
}
</code></pre>
<p>Another scenario is when the proxy instance itself is leaking its target.</p>
<pre><code>public interface IFoo
{
    IFoo A();
}

public class Foo
{
    public IFoo A()
    {
        return this;
    }
}
</code></pre>
<p><strong>LightInject</strong> will take care of this scenario and detect that we are about to return <strong>this</strong> from a method and replace the return value with the proxy instance instead. </p>
<p>Other scenarios such as event handlers or passing "this" to another method is NOT taken care of by <strong>LightInject</strong> as it is not possible without modifying the code in the target type itself. </p>
<h2 id="class-proxies">Class Proxies</h2>
<p>Starting from version 1.0.0.4, <strong>LightInject.Interception</strong> can be used to intercept classes with virtual members.</p>
<pre><code>public class Foo
{
    public virtual void A()
    {
    }
}
</code></pre>
<p>Any member that is marked as virtual can be intercepted.    </p>
<pre><code>var container = new ServiceContainer();
container.Register&lt;Foo&gt;();
container.Intercept(sr =&gt; sr.ServiceType == typeof(Foo), factory =&gt; new SampleInterceptor());
</code></pre>
<p>Class proxies are implemented internally by subclassing the target type and overriding virtual members to support interception.  </p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../designpatterns/" title="Patterns" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Patterns
              </span>
            </div>
          </a>
        
        
          <a href="../autofactory/" title="AutoFactory" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                AutoFactory
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>